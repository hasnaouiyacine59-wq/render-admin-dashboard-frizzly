<!-- API-based Notification Polling (for app_api.py) -->
<script>
    let knownOrderIds = new Set();
    let notifications = [];
    let isFirstLoad = true;

    // Poll for new orders every 10 seconds
    async function checkForNewOrders() {
        try {
            const response = await fetch('/api/poll-orders');
            if (!response.ok) return;
            
            const data = await response.json();
            const orders = data.orders || [];
            
            if (isFirstLoad) {
                // First load - just record existing orders
                orders.forEach(order => knownOrderIds.add(order.id));
                isFirstLoad = false;
                console.log('Initial load: ' + orders.length + ' orders');
            } else {
                // Check for new orders
                let newOrders = [];
                orders.forEach(order => {
                    if (!knownOrderIds.has(order.id)) {
                        knownOrderIds.add(order.id);
                        newOrders.push({
                            id: order.id,
                            orderId: order.orderId || order.id,
                            totalAmount: order.totalAmount || 0,
                            timestamp: new Date()
                        });
                    }
                });
                
                if (newOrders.length > 0) {
                    console.log('New orders detected: ' + newOrders.length);
                    newOrders.forEach(order => addNotification(order));
                    showNotification(newOrders.length);
                    playNotificationSound();
                }
            }
        } catch (error) {
            console.error('Error polling orders:', error);
        }
    }

    function addNotification(order) {
        notifications.unshift(order);
        if (notifications.length > 10) notifications.pop();
        updateNotificationDropdown();
    }

    function updateNotificationDropdown() {
        const list = document.getElementById('notificationList');
        const badge = document.getElementById('notificationBadge');
        
        if (notifications.length === 0) {
            list.innerHTML = `
                <li class="text-center text-muted py-3">
                    <i class="bi bi-bell-slash fs-4 d-block mb-2"></i>
                    No new notifications
                </li>
            `;
            badge.style.display = 'none';
        } else {
            list.innerHTML = notifications.map(notif => `
                <li>
                    <a class="dropdown-item" href="/orders/${notif.id}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>New Order #${notif.orderId.slice(-8)}</strong>
                                <div class="text-muted small">$${notif.totalAmount.toFixed(2)}</div>
                            </div>
                            <small class="text-muted">${formatTime(notif.timestamp)}</small>
                        </div>
                    </a>
                </li>
            `).join('');
            badge.textContent = notifications.length;
            badge.style.display = 'inline-block';
        }
    }

    function formatTime(date) {
        const now = new Date();
        const diff = Math.floor((now - date) / 1000);
        if (diff < 60) return 'Just now';
        if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
        if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
        return date.toLocaleDateString();
    }

    function clearNotifications() {
        notifications = [];
        updateNotificationDropdown();
    }

    window.clearNotifications = clearNotifications;

    function showNotification(count) {
        const toast = new bootstrap.Toast(document.getElementById('orderNotification'));
        document.getElementById('notificationBody').textContent = 
            count === 1 ? 'A new order has been placed!' : `${count} new orders have been placed!`;
        toast.show();
    }

    function playNotificationSound() {
        const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIGGS57OihUBELTKXh8bllHAU2jdXvzn0pBSh+zPDajzsKElyx6OyrWBUIQ5zd8sFuJAUuhM/z24k2CBhku+zooVARC0yl4fG5ZRwFNo3V7859KQUofsz');
        audio.play().catch(() => {});
    }

    // Start polling when page loads
    document.addEventListener('DOMContentLoaded', function() {
        checkForNewOrders(); // Initial check
        setInterval(checkForNewOrders, 10000); // Poll every 10 seconds
    });
</script>
